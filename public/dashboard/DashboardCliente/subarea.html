<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../../css/dashS.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <title>Dashboard</title>
</head>

<body onload="kpis()">
    <div class="dash">
        <div class="conteudo">
            <div class="olac">
                    <a href="./dash.html"><img src="../../assets/imgs/logo png.png" alt=""></a>
                    <h1>Hectare 1 - Subárea 1</h1>
                    <button onclick="sair()" class="btsair">Sair</button>
                </div>
            <div class="graficos">
                    <div class="secaocima">
                        <div class="kpi1">
                            <h4>Umidade Atual</h4>
                            <p><b class="u" id="umiAtual"></b></p>
                            <p id="tipoUmi"></p>
                        </div>
                        <div class="grafico">
                            <h3>MONITORAMENTO EM TEMPO REAL</h3>
                            <canvas id="mychart1"></canvas>
                        </div>
                    </div>
                    <div class="kpis">
                        <div class="kpi2">
                            <h4>PICO MÁXIMO</h4>
                            <p><b id="pMax"></b></p>
                            <p>(<b id="hrMax"></b>)</p>
                        </div>  
                        <div class="kpi2">
                            <h4>PICO MÍNIMO</h4>
                            <p><b id="pMin"></b></p>
                            <p>(<b id="hrMin"></b>)</p>
                        </div>
                        <div class="kpi2">
                            <h4>ALERTAS NAS ÚLTIMAS 24h</h4>
                            <p><b id="qtdAlertas"></b></p>
                            <p><b>Ocorrências</b></p>
                        </div>
                    </div>
            </div>
        </div>
    </div>
</body>
<script>

const ctxline = document.getElementById("mychart1")

                  new Chart(ctxline, {
        type: 'line',
        data: {
            labels: ['10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00', '17:00'],
            datasets: [{
                label: 'Umidade do solo (%)',
                data: [75, 73, 76, 77, 72, 70, 68, 70],
                borderColor: '#174219',
                backgroundColor: '#174219',
                pointRadius: 4.5,
                pointBackgroundColor: '#7cb342'

            }, {
                label: 'Horário',
                borderColor: '#7cb342',
                backgroundColor: '#7cb342'

            }, {
                label: 'Nível máximo recomendado',
                data: [80, 80, 80, 80, 80, 80, 80, 80],
                borderColor: '#4e5a65',
                backgroundColor: '#4e5a65', // cinza
                borderWidth: 3,
                pointRadius: 0,
                borderDash: [8 , 8]


            }, {
                label: 'Nível mínimo recomendado',
                data: [60, 60, 60, 60, 60, 60, 60, 60],
                borderColor: '#4e5a65',
                backgroundColor: '#4e5a65',
                borderWidth: 3,
                pointRadius: 0,
                borderDash: [8 , 8]

            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    title: { display: true, text: 'Umidade do solo (%)' },
                    min: 40,
                    max: 90
                },
                x: {
                    title: { display: true, text: 'Horário' },
                }
            }
        }
    })

    var codEmpresaVar = sessionStorage.COD_EMPRESA
    function kpis() {

        
         fetch(`/medidas/mostrarKpis`,{
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                codEmpresaServer: codEmpresaVar
            })  
            }).then(function (response) {
                
                if (response.ok) {
                    response.json().then(function (resposta) {
                        console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                        var estadoUmidade = 0
                        
                        resposta.forEach(item => {
                        pMax.innerHTML = item.maxumi + '%';
                        pMin.innerHTML = item.minumi + '%';
                        qtdAlertas.innerHTML = item.qtdOcorrencia;
                        estadoUmidade = item.umiatual
                        umiAtual.innerHTML = estadoUmidade + '%';
                        hrMin.innerHTML = item.hrMin;
                        hrMax.innerHTML = item.hrMax;
                    })
                        if(estadoUmidade >= 60 && estadoUmidade <= 80) {
                            tipoUmi.innerHTML = `Umidade estável`
                        }   else if(estadoUmidade > 80) {
                            tipoUmi.innerHTML = `Umidade acima do ideal`
                        }   else {  
                            tipoUmi.innerHTML = `Umidade abaixo do ideal`
                        }

                    });
                } else {
                    console.error('Nenhum dado encontrado ou erro na API');
                }
            })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });


    }


    function sair() {
        window.location.href = "../../index.html"
    }

    function inicio() {
        window.location.href = "dash.html"
    }

    function hectare() {
        window.location.href = "hectare.html"
    }

    function subarea() {
        window.location.href = "subarea.html"
    }

    function historico() {
        window.location.href = "historico.html"
    }

    function subareasel() {
        window.location.href = "subareaone.html"
    }

</script>


</html>
<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../../css/dash.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <title>Dashboard</title>
</head>

<body onload="dados(); alertas()">
    <div class="dash">
        <div class="conteudo">
            <div class="dashdireita">
                <div class="olac">
                    <img src="../../assets/imgs/logo png.png" alt="">
                    <h1>Olá, <span id="name"></span>, seja bem-vindo!</h1>
                    <button onclick="sair()" class="btsair">Sair</button>
                </div>
                <div class="gerais">
                    <div class="kpis">
                        <div class="cardskp">
                            <div class="sensores">
                                <p>Saúde dos sensores da sua plantação:</p>
                            </div>
                            <div class="online">
                                <p>Online:</p> <span id="sensOn"></span>
                            </div>
                            <div class="offline">
                                <p>Offline:</p> <span id="sensOff"></span>
                            </div>
                        </div>
                    </div>
                    <div class="hectares">
                        <h1>Monitoramento dos Hectares</h1>
                        <div class="cardhectares">
                            <div class="hect">
                                <h1>Hectare 1 - Subárea 1</h1>
                                <img src="../../assets/imgs/campo.png" alt="">
                                <button onclick="location.href='subarea.html'">Ver detalhes</button>
                            </div>
                            <div class="hect">
                                <h1>Hectare 1 - Subárea 2</h1>
                                <img src="../../assets/imgs/campo.png" alt="">
                                <button onclick="alert('O sensor desta subárea está inativo')">Ver detalhes</button>
                            </div>
                            <div class="alerts">
                                <h1>Últimos alertas</h1>
                                <div class="ocorrencias">
                                    <div class="linhaAlert" id="oc1"></div>
                                    <div class="linhaAlert" id="oc2"></div>
                                    <div class="linhaAlert" id="oc3"></div>
                                    <div class="linhaAlert" id="oc4"></div>
                                    <div class="linhaAlert" id="oc5"></div>
                                    <div class="linhaAlert" id="oc6"></div>
                                    <div class="linhaAlert" id="oc7"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
<script>

    function dados() {
        document.getElementById("name").innerHTML = sessionStorage.NOME_USUARIO
        var codEmpresaVar = sessionStorage.COD_EMPRESA


       fetch(`/medidas/saudeSensores`,{
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                codEmpresaServer: codEmpresaVar
            })  
            }).then(function (response) {
                
                if (response.ok) {
                    response.json().then(function (resposta) {
                        console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);

                        let sensoresOn = 0
                        let sensoresOff = 0

                        resposta.forEach(item => {
                            sensOn.innerHTML = item.Online
                            sensOff.innerHTML = item.Offline
                        })

                        console.log(sensoresOn)
                        console.log(sensoresOff)

                    });
                } else {
                    console.error('Nenhum dado encontrado ou erro na API');
                }
            })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });

    }


    function alertas() {

        var codEmpresaVar = sessionStorage.COD_EMPRESA
        fetch(`/medidas/alertasDash`,{
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                codEmpresaServer: codEmpresaVar
            })  
            }).then(function (response) {
                if (response.ok) {
                    response.json().then(function (resposta) {
                        console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);

                        oc1.innerHTML = resposta[0].Ocorrência
                        oc2.innerHTML = resposta[1].Ocorrência
                        oc3.innerHTML = resposta[2].Ocorrência
                        oc4.innerHTML = resposta[3].Ocorrência
                        oc5.innerHTML = resposta[4].Ocorrência
                        oc6.innerHTML = resposta[5].Ocorrência
                        oc7.innerHTML = resposta[6].Ocorrência
                        

                    });
                } else {
                    console.error('Nenhum dado encontrado ou erro na API');
                }
            })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });

    }

    function sair() {
        window.location.href = "../../index.html"
    }

    function inicio() {
        window.location.href = "dash.html"
    }

    function hectare() {
        window.location.href = "hectare.html"
    }

    function subarea() {
        window.location.href = "subarea.html"
    }

    function historico() {
        window.location.href = "historico.html"
    }
    
</script>


</html>